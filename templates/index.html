<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ SABRINA - Space Mission Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Fredoka:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a3e 30%, #2d1b4e 60%, #1a1a3e 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Animated Starfield */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1800px;
            margin: 0 auto;
            padding: 15px;
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .container.dashboard-mode {
            height: calc(100vh - 20px);
        }
        
        /* Dashboard Layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        @media (max-width: 1400px) {
            .dashboard-container {
                grid-template-columns: 280px 1fr 320px;
            }
        }
        
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
        }
        
        .dashboard-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(100, 200, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .dashboard-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .dashboard-panel::-webkit-scrollbar-thumb {
            background: rgba(100, 255, 218, 0.5);
            border-radius: 10px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
        }

        /* Header with Glow Effect - Compact */
        .header {
            text-align: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(100, 200, 255, 0.4);
            box-shadow: 0 5px 20px rgba(100, 255, 218, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 1em;
            margin-top: 5px;
        }
        
        .header-info {
            text-align: right;
            font-size: 0.9em;
            color: #64ffda;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 10px 40px rgba(100, 255, 218, 0.3), inset 0 0 30px rgba(100, 255, 218, 0.1); }
            50% { box-shadow: 0 10px 50px rgba(100, 255, 218, 0.5), inset 0 0 40px rgba(100, 255, 218, 0.2); }
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5em;
            font-weight: 900;
            background: linear-gradient(45deg, #ff6b9d, #c44569, #f8b500, #ff6b9d);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientMove 3s ease infinite;
            text-shadow: 0 0 40px rgba(255, 107, 157, 0.5);
            margin-bottom: 10px;
        }

        @keyframes gradientMove {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.4em;
            color: #64ffda;
            margin-top: 10px;
            text-shadow: 0 0 20px rgba(100, 255, 218, 0.8);
        }

        /* Status Cards - Compact */
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid rgba(100, 200, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.6s ease-out;
            transition: all 0.3s;
        }

        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(100, 255, 218, 0.4);
        }
        
        /* Compact Metrics */
        .metrics-compact {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .metric-card-compact {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid rgba(100, 200, 255, 0.2);
            transition: all 0.3s;
        }
        
        .metric-card-compact:hover {
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(100, 255, 218, 0.5);
            transform: scale(1.05);
        }
        
        .metric-label-compact {
            font-size: 0.85em;
            color: #64ffda;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-value-compact {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            font-weight: bold;
            color: #ffffff;
        }
        
        /* Compact Progress Bars */
        .progress-container-compact {
            margin: 12px 0;
        }
        
        .progress-label-compact {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: #64ffda;
        }
        
        .progress-bar-compact {
            height: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(100, 200, 255, 0.3);
        }
        
        .progress-fill-compact {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #c44569, #f8b500, #00e676, #00bcd4);
            background-size: 200% 100%;
            border-radius: 12px;
            transition: width 1s ease-out;
            animation: progressShine 2s infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .status-badge {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 20px;
            animation: pulse 2s infinite, bounce 1s ease-in-out infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .status-success {
            background: linear-gradient(135deg, #00e676, #00bcd4, #00e676);
            background-size: 200% 200%;
            animation: gradientMove 2s ease infinite, pulse 2s infinite;
            color: white;
            box-shadow: 0 0 30px rgba(0, 230, 118, 0.6);
        }

        .status-failure {
            background: linear-gradient(135deg, #ff1744, #f50057, #ff1744);
            background-size: 200% 200%;
            animation: gradientMove 2s ease infinite, shake 0.5s;
            color: white;
            box-shadow: 0 0 30px rgba(255, 23, 68, 0.6);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .status-active {
            background: linear-gradient(135deg, #ff6f00, #ffa726, #ff6f00);
            background-size: 200% 200%;
            animation: gradientMove 2s ease infinite;
            color: white;
            box-shadow: 0 0 30px rgba(255, 111, 0, 0.6);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.4);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(100, 200, 255, 0.3);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(100, 255, 218, 0.1), transparent);
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-card:hover {
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(100, 255, 218, 0.6);
            transform: scale(1.1) rotate(2deg);
            box-shadow: 0 10px 30px rgba(100, 255, 218, 0.4);
        }

        .metric-label {
            font-size: 1em;
            color: #64ffda;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .metric-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2em;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 1;
        }

        .metric-unit {
            font-size: 0.6em;
            color: #b0bec5;
            position: relative;
            z-index: 1;
        }

        /* Progress Bars */
        .progress-container {
            margin: 20px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1em;
            color: #64ffda;
            font-weight: 600;
        }

        .progress-bar {
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid rgba(100, 200, 255, 0.4);
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #c44569, #f8b500, #00e676, #00bcd4);
            background-size: 200% 100%;
            border-radius: 20px;
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Rocket Animation - Compact */
        .rocket-container {
            text-align: center;
            margin: 20px 0;
            height: 120px;
            position: relative;
        }

        .rocket {
            font-size: 3.5em;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(100, 255, 218, 0.8));
            position: relative;
            z-index: 1;
        }
        
        /* Side Panel Styles */
        .side-panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3em;
            color: #64ffda;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 0 15px rgba(100, 255, 218, 0.6);
            border-bottom: 2px solid rgba(100, 255, 218, 0.3);
            padding-bottom: 10px;
        }
        
        /* Selection screen stays full width */
        .selection-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .selection-container .status-card {
            max-width: 100%;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
            50% { transform: translateY(-25px) rotate(5deg) scale(1.1); }
        }

        .rocket-launching {
            animation: launch 2s ease-out forwards;
        }

        @keyframes launch {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-300px) scale(0.3); opacity: 0; }
        }

        /* Control Panel - Compact */
        .control-panel {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(100, 200, 255, 0.4);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.8s ease-out;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .control-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            margin-bottom: 15px;
            color: #64ffda;
            text-align: center;
            text-shadow: 0 0 20px rgba(100, 255, 218, 0.8);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #b0bec5;
            font-weight: 500;
        }

        input[type="number"],
        input[type="range"] {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(100, 200, 255, 0.4);
            border-radius: 15px;
            color: #ffffff;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 12px;
            background: linear-gradient(90deg, #ff6b9d, #f8b500, #00e676);
            border-radius: 10px;
            outline: none;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #64ffda, #00bcd4);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.8);
            transition: all 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.3);
            box-shadow: 0 0 30px rgba(100, 255, 218, 1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #64ffda, #00bcd4);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.8);
            border: none;
        }

        input[type="number"]:focus,
        input[type="range"]:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 30px rgba(100, 255, 218, 0.5);
            background: rgba(0, 0, 0, 0.7);
        }

        .input-hint {
            font-size: 1em;
            color: #64ffda;
            margin-top: 10px;
            font-style: italic;
            text-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
        }

        /* Buttons - Compact */
        .btn {
            width: 100%;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Fredoka', sans-serif;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background: linear-gradient(135deg, #ff6b9d, #c44569, #f8b500);
            background-size: 200% 200%;
            color: white;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.4);
            position: relative;
            overflow: hidden;
            animation: gradientMove 3s ease infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-top: auto;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 107, 157, 0.6);
        }

        .btn:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-success {
            background: linear-gradient(135deg, #00e676, #00bcd4);
            box-shadow: 0 8px 25px rgba(0, 230, 118, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff1744, #f50057);
            box-shadow: 0 8px 25px rgba(255, 23, 68, 0.4);
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        /* Alert Messages - Compact */
        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            animation: slideIn 0.5s ease-out;
            border: 2px solid;
            font-size: 0.95em;
        }
        
        .alert p {
            margin: 8px 0;
            line-height: 1.5;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-success {
            background: rgba(0, 230, 118, 0.3);
            border-color: rgba(0, 230, 118, 0.6);
            color: #00e676;
            box-shadow: 0 0 30px rgba(0, 230, 118, 0.4);
        }

        .alert-danger {
            background: rgba(255, 23, 68, 0.3);
            border-color: rgba(255, 23, 68, 0.6);
            color: #ff6b9d;
            box-shadow: 0 0 30px rgba(255, 23, 68, 0.4);
        }

        .alert-info {
            background: rgba(100, 255, 218, 0.3);
            border-color: rgba(100, 255, 218, 0.6);
            color: #64ffda;
            box-shadow: 0 0 30px rgba(100, 255, 218, 0.4);
        }

        /* Planet Cards */
        .planet-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 3px solid rgba(100, 200, 255, 0.3);
            transition: all 0.4s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .planet-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(100, 255, 218, 0.1), transparent);
            animation: rotate 4s linear infinite;
        }

        .planet-card:hover {
            transform: translateY(-15px) scale(1.08) rotate(3deg);
            border-color: rgba(100, 255, 218, 0.8);
            box-shadow: 0 20px 60px rgba(100, 255, 218, 0.7), 0 0 40px rgba(248, 181, 0, 0.4);
        }
        
        .planet-card:hover .planet-icon {
            transform: scale(1.2) rotate(15deg);
            filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.8));
        }

        .planet-icon {
            font-size: 5em;
            margin: 20px 0;
            animation: float 4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
            transition: all 0.4s ease;
        }
        
        .planet-card:hover .launch-button {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(0, 230, 118, 0.7);
            background: linear-gradient(135deg, #00bcd4, #00e676);
        }
        
        .launch-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .planet-card:hover .launch-button::before {
            width: 300px;
            height: 300px;
        }

        /* Distance Visualization */
        .distance-visual {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 30px 0;
            padding: 30px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            border: 2px solid rgba(100, 200, 255, 0.3);
        }

        .planet-visual {
            font-size: 4em;
            animation: rotate 20s linear infinite;
            filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.6));
        }

        .path {
            flex: 1;
            height: 6px;
            background: linear-gradient(90deg, #64ffda, transparent, #64ffda);
            margin: 0 30px;
            position: relative;
            border-radius: 10px;
        }

        .rocket-position {
            position: absolute;
            left: var(--progress, 0%);
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.5em;
            transition: left 1s ease-out;
            filter: drop-shadow(0 0 20px rgba(100, 255, 218, 0.8));
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5em;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .control-panel {
                padding: 25px;
            }
        }

        /* Celebration Animation */
        @keyframes confetti {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(500px) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ff6b9d;
            animation: confetti 3s ease-out forwards;
            z-index: 1000;
        }

        /* AI Tutor Button */
        .ai-tutor-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: 3px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5);
            transition: all 0.3s;
            z-index: 100;
            animation: pulse 2s infinite;
        }

        .ai-tutor-btn:hover {
            transform: scale(1.2) rotate(10deg);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.8);
        }
        
        /* Educational Tooltips */
        .tooltip-trigger {
            position: relative;
            cursor: help;
            border-bottom: 2px dotted #64ffda;
            display: inline-block;
        }
        
        .tooltip {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #64ffda;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #64ffda;
            width: 300px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            box-shadow: 0 10px 30px rgba(100, 255, 218, 0.5);
        }
        
        .tooltip-trigger:hover .tooltip {
            opacity: 1;
            pointer-events: auto;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #64ffda;
        }
        
        /* Learn More Sections */
        .learn-more {
            margin-top: 15px;
            padding: 15px;
            background: rgba(100, 255, 218, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(100, 255, 218, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .learn-more:hover {
            background: rgba(100, 255, 218, 0.2);
            border-color: rgba(100, 255, 218, 0.5);
        }
        
        .learn-more-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            margin-top: 10px;
        }
        
        .learn-more.expanded .learn-more-content {
            max-height: 1000px;
        }
        
        /* Step Indicator */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }
        
        .step::after {
            content: '‚Üí';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            color: #64ffda;
            font-size: 1.5em;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(100, 255, 218, 0.2);
            border: 2px solid #64ffda;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .step.active .step-number {
            background: linear-gradient(135deg, #64ffda, #00bcd4);
            color: #000;
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.6);
            animation: pulse 2s infinite;
        }
        
        .step.completed .step-number {
            background: linear-gradient(135deg, #00e676, #00bcd4);
            color: #000;
        }
        
        /* Help Button */
        .help-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(100, 255, 218, 0.2);
            border: 2px solid #64ffda;
            color: #64ffda;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1.2em;
        }
        
        .help-btn:hover {
            background: rgba(100, 255, 218, 0.4);
            transform: scale(1.1);
        }
        
        /* Educational Card */
        .edu-card {
            background: rgba(100, 255, 218, 0.1);
            border: 2px solid rgba(100, 255, 218, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .edu-card-title {
            color: #64ffda;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edu-card-content {
            color: #b0bec5;
            line-height: 1.6;
            font-size: 0.95em;
        }
        
        /* Concept Explanation Box */
        .concept-box {
            background: rgba(248, 181, 0, 0.1);
            border-left: 4px solid #f8b500;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }
        
        .concept-box-title {
            color: #f8b500;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .concept-box-content {
            color: #ffffff;
            line-height: 1.6;
        }
        
        /* Success Celebration Animation */
        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.15) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-3deg); }
        }
        
        .celebrate {
            animation: celebrate 0.5s ease-in-out infinite;
        }
        
        /* Confetti Effect */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f8b500;
            position: absolute;
            animation: confetti-fall 3s linear infinite;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Mission Statistics Card */
        .mission-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(100, 255, 218, 0.3);
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            background: rgba(100, 255, 218, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(100, 255, 218, 0.2);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #64ffda;
            font-family: 'Orbitron', sans-serif;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #b0bec5;
        }
        
        /* Visual Feedback Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        /* Rocket Animation */
        @keyframes rocketLaunch {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
            100% { transform: translateY(0) scale(1); }
        }
        
        .rocket-launching {
            animation: rocketLaunch 1s ease-in-out infinite;
        }
        
        /* Progress Pulse */
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .progress-pulse {
            animation: progressPulse 2s ease-in-out infinite;
        }
        
        /* Achievement Badge */
        .achievement-badge {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #f8b500, #ff6b9d);
            border-radius: 25px;
            margin: 5px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(248, 181, 0, 0.5);
            animation: slideIn 0.5s ease-out;
        }
        
        /* Interactive Hover Effects */
        .metric-card-compact:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(100, 255, 218, 0.4);
            transition: all 0.3s;
        }
        
        /* Visual Velocity Indicator */
        .velocity-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .velocity-safe {
            background: rgba(0, 230, 118, 0.3);
            color: #00e676;
            border: 2px solid #00e676;
        }
        
        .velocity-warning {
            background: rgba(248, 181, 0, 0.3);
            color: #f8b500;
            border: 2px solid #f8b500;
        }
        
        .velocity-danger {
            background: rgba(255, 107, 157, 0.3);
            color: #ff6b9d;
            border: 2px solid #ff6b9d;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Animated Starfield -->
    <div class="stars" id="stars"></div>

    <div class="container{% if state.status != 'SELECTION' and state.status != 'SUCCESS' and state.status != 'FAILURE' %} dashboard-mode{% endif %}">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>üöÄ SABRINA üöÄ</h1>
                <p class="subtitle">Space Mission Simulator for Future Astronauts!</p>
                {% if space_name %}
                <p style="font-size: 0.9em; color: #f8b500; margin-top: 5px; font-weight: bold;">Mission Control: {{ space_name }}</p>
                {% endif %}
            </div>
            {% if state.status != 'SELECTION' and state.target_planet_data %}
            <div class="header-info">
                <div>üåç {{ state.target_planet_data.name }}</div>
                <div>Day: {{ state.mission_day }} | Fuel: {{ state.fuel | round(0) | int }}/{{ state.initial_fuel }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Success/Failure Screens (Full Width) -->
        {% if state.status == 'SUCCESS' %}
        <div class="status-card slide-in">
            <div class="status-badge status-success celebrate">üéâ MISSION COMPLETE! üéâ</div>
            <div class="alert alert-success">
                <h2 style="margin-bottom: 15px; font-size: 1.5em;">üåü Awesome Job, {% if space_name %}{{ space_name }}{% else %}Space Commander{% endif %}! üåü</h2>
                <p style="font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">
                    You successfully collected <strong>{{ state.collected_data_units }} units</strong> of valuable scientific data and returned home safely! 
                    Your mission planning and execution were outstanding! üöÄ‚ú®
                </p>
                
                <!-- Mission Statistics -->
                <div class="mission-stats">
                    <div class="stat-card">
                        <div class="stat-label">‚è±Ô∏è Mission Duration</div>
                        <div class="stat-value">{{ state.mission_day }}</div>
                        <div class="stat-label">days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚õΩ Fuel Efficiency</div>
                        <div class="stat-value">{{ ((state.fuel / state.initial_fuel) * 100) | round(0) | int }}%</div>
                        <div class="stat-label">remaining</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üî¨ Data Collected</div>
                        <div class="stat-value">{{ state.collected_data_units }}</div>
                        <div class="stat-label">units</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ü™ê Planet Explored</div>
                        <div class="stat-value" style="font-size: 1.5em;">{{ state.target_planet_data.icon if state.target_planet_data else 'üåç' }}</div>
                        <div class="stat-label">{{ state.target_planet_data.name if state.target_planet_data else 'Unknown' }}</div>
                    </div>
                </div>
                
                <!-- Achievements -->
                <div style="margin: 20px 0; text-align: center;">
                    <h3 style="color: #64ffda; margin-bottom: 15px; font-size: 1.3em;">üèÜ Mission Achievements</h3>
                    <div>
                        <span class="achievement-badge">‚úÖ Successful Landing</span>
                        <span class="achievement-badge">üìä Data Collection Complete</span>
                        <span class="achievement-badge">üè† Safe Return</span>
                        {% if state.fuel > state.initial_fuel * 0.3 %}
                        <span class="achievement-badge">‚õΩ Fuel Efficient</span>
                        {% endif %}
                        {% if state.mission_day < 100 %}
                        <span class="achievement-badge">‚ö° Fast Mission</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Educational Summary -->
                <div class="edu-card" style="margin-top: 20px;">
                    <div class="edu-card-title">üéì What You Learned</div>
                    <div class="edu-card-content">
                        <strong>Congratulations!</strong> You've mastered key space science concepts:<br>
                        ‚Ä¢ <strong>Launch Physics:</strong> Understanding TWR and escape velocity<br>
                        ‚Ä¢ <strong>Space Travel:</strong> Managing fuel and course corrections<br>
                        ‚Ä¢ <strong>Landing:</strong> Precise velocity control and retro-burns<br>
                        ‚Ä¢ <strong>Mission Planning:</strong> Balancing speed, fuel, and safety<br><br>
                        <strong>Ready for your next challenge?</strong> Try a different planet to learn new concepts! üöÄ
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <a href="{{ url_for('reset_mission') }}" class="btn btn-success" style="text-decoration: none; display: inline-block; max-width: 400px;">
                        <span>üöÄ Launch Another Mission!</span>
                    </a>
                </div>
            </div>
        </div>

        {% elif state.status == 'FAILURE' %}
        <div class="status-card slide-in">
            <div class="status-badge status-failure">üö® Mission Challenge üö®</div>
            <div class="alert alert-danger">
                <h2 style="margin-bottom: 15px; font-size: 1.5em;">Mission Day {{ state.mission_day }}</h2>
                <p style="font-size: 1.1em; margin-bottom: 10px;"><strong>Challenge Encountered:</strong> {{ state.error_code }}</p>
                
                <!-- Helpful Error Explanations -->
                <div class="edu-card" style="margin: 20px 0; background: rgba(255, 107, 157, 0.1); border-color: rgba(255, 107, 157, 0.3);">
                    <div class="edu-card-title" style="color: #ff6b9d;">üí° What Happened?</div>
                    <div class="edu-card-content">
                        {% if state.error_code == 'HIGH_VELOCITY_IMPACT' %}
                        <strong>High Velocity Impact:</strong> Your spacecraft was moving too fast when it reached the surface. 
                        You need more retro-burn time to slow down! Try increasing your burn duration next time. üõë
                        {% elif state.error_code == 'LOW_FUEL_LAUNCH' or state.error_code == 'OUT_OF_FUEL_CRUISE' or state.error_code == 'OUT_OF_FUEL_BURN' %}
                        <strong>Out of Fuel:</strong> You ran out of fuel! This means you used too much fuel earlier in the mission. 
                        Try being more efficient with your TWR and burns. ‚õΩ
                        {% elif state.error_code == 'GRAVITY_FAIL' %}
                        <strong>Gravity Too Strong:</strong> Your TWR was less than 1.0, so gravity won! 
                        You need TWR > 1.0 to lift off. Try a higher TWR value! üöÄ
                        {% elif state.error_code == 'LOW_FUEL_LANDING_CRASH' %}
                        <strong>Landing Fuel Shortage:</strong> You didn't have enough fuel for the landing burn. 
                        Save more fuel during launch and cruise phases! üõ∏
                        {% elif state.error_code == 'STRANDED_NO_RETURN_FUEL' %}
                        <strong>Stranded:</strong> Not enough fuel to return home! Always save fuel for the return journey. 
                        Plan your fuel usage throughout the mission! üè†
                        {% else %}
                        <strong>Mission Challenge:</strong> Every great astronaut learns from challenges! 
                        Click the ü§ñ AI Tutor button to get personalized help understanding what happened! üåü
                        {% endif %}
                    </div>
                </div>
                
                <!-- Mission Statistics Even on Failure -->
                <div class="mission-stats">
                    <div class="stat-card">
                        <div class="stat-label">‚è±Ô∏è Mission Duration</div>
                        <div class="stat-value">{{ state.mission_day }}</div>
                        <div class="stat-label">days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚õΩ Fuel Remaining</div>
                        <div class="stat-value">{{ state.fuel | round(0) | int }}</div>
                        <div class="stat-label">units</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üì° Distance Traveled</div>
                        <div class="stat-value">{{ (state.altitude_km / 1000000) | round(1) }}M</div>
                        <div class="stat-label">km</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚ö° Final Velocity</div>
                        <div class="stat-value">{{ state.velocity_km_s | round(2) }}</div>
                        <div class="stat-label">km/s</div>
                    </div>
                </div>
                
                <p style="font-size: 1em; line-height: 1.6; margin-top: 20px;">
                    <strong>Don't give up!</strong> Every great astronaut learns from challenges! üåü<br>
                    Click the <strong>ü§ñ AI Tutor button</strong> (bottom right) to learn what happened and how to improve next time!
                </p>
                
                <div style="text-align: center; margin-top: 30px;">
                    <a href="{{ url_for('reset_mission') }}" class="btn btn-danger" style="text-decoration: none; display: inline-block; max-width: 400px; margin-right: 15px;">
                        <span>üîÑ Start New Mission!</span>
                    </a>
                    <button onclick="openAiTutor('I failed the mission with error code {{ state.error_code }}. Explain what went wrong and how I can improve next time!')" class="btn" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); max-width: 400px;">
                        <span>ü§ñ Ask AI Tutor for Help</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Layout for Active Mission -->
        {% elif state.status != 'SELECTION' %}
        <div class="dashboard-container">
            <!-- Left Panel: Mission Status & Metrics -->
            <div class="dashboard-panel">
                <div class="side-panel-title">
                    {% if state.status == 'PRE_LAUNCH' %}üöÄ Ready for Launch
                    {% elif state.status == 'CRUISING' %}üåå Deep Space Cruise
                    {% elif state.status == 'LANDING_PREP' %}ü™ê Landing Approach
                    {% elif state.status == 'SURFACE_DATA' %}üî¨ Collecting Data
                    {% elif state.status == 'RETURN_PREP' %}üè† Returning Home
                    {% else %}{{ state.status }}
                    {% endif %}
                </div>
                
                <div class="metrics-compact">
                    <div class="metric-card-compact">
                        <div class="metric-label-compact">‚è±Ô∏è Mission Day</div>
                        <div class="metric-value-compact">{{ state.mission_day }}</div>
                    </div>
                    <div class="metric-card-compact">
                        <div class="metric-label-compact">üì° Altitude</div>
                        <div class="metric-value-compact">{{ state.altitude_km | round(0) | int }}</div>
                    </div>
                    <div class="metric-card-compact">
                        <div class="metric-label-compact">‚ö° Velocity</div>
                        <div class="metric-value-compact">
                            {{ state.velocity_km_s | round(2) }}
                            {% if state.status == 'LANDING_PREP' %}
                                {% if state.velocity_km_s <= 0.15 %}
                                <span class="velocity-indicator velocity-safe">SAFE</span>
                                {% elif state.velocity_km_s <= 1.0 %}
                                <span class="velocity-indicator velocity-warning">WARNING</span>
                                {% else %}
                                <span class="velocity-indicator velocity-danger">TOO FAST</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="metric-card-compact">
                        <div class="metric-label-compact">üî¨ Data</div>
                        <div class="metric-value-compact">{{ state.collected_data_units }}/{{ state.required_data_units }}</div>
                    </div>
                </div>

                <!-- Rocket Animation -->
                <div class="rocket-container">
                    <div class="rocket{% if state.status == 'PRE_LAUNCH' %} rocket-launching{% endif %}" id="rocket">
                        {% if state.status == 'PRE_LAUNCH' %}üöÄ
                        {% elif state.status == 'CRUISING' %}üõ∏
                        {% elif state.status == 'LANDING_PREP' %}üõ∏
                        {% elif state.status == 'SURFACE_DATA' %}üî¨
                        {% elif state.status == 'RETURN_PREP' %}üöÄ
                        {% endif %}
                    </div>
                </div>
                
                <!-- Real-time Mission Info -->
                {% if state.status == 'CRUISING' %}
                <div style="margin-top: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border: 2px solid rgba(100, 200, 255, 0.3);">
                    <div style="font-size: 0.9em; color: #64ffda; margin-bottom: 8px; font-weight: bold;">üåå Current Status</div>
                    <div style="font-size: 0.85em; color: #b0bec5; line-height: 1.8;">
                        <div>Speed: <strong style="color: #64ffda;">{{ state.velocity_km_s | round(2) }} km/s</strong></div>
                        <div>Traveled: <strong style="color: #64ffda;">{{ (state.altitude_km / 1000000) | round(1) }}M km</strong></div>
                        <div>Remaining: <strong style="color: #f8b500;">{{ ((state.target_distance_km - state.altitude_km) / 1000000) | round(1) }}M km</strong></div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(100, 255, 218, 0.2);">
                            <em style="color: #64ffda;">üí° Each 10-day step covers ~{{ (state.velocity_km_s * 10 * 24 * 3600 / 1000000) | round(1) }}M km at current speed</em>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Center Panel: Control Panel -->
            <div class="dashboard-panel main-content" style="position: relative;">
                {% if state.status == 'PRE_LAUNCH' %}
                <button class="help-btn" onclick="openAiTutor('What is Thrust-to-Weight Ratio (TWR) and why is it important for launching a rocket?')" title="Get Help">?</button>
                <div class="control-panel-content">
                    <h2 class="control-title">üöÄ Phase 1: Launch Sequence</h2>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step active">
                            <div class="step-number">1</div>
                            <div style="font-size: 0.85em; color: #64ffda;">Launch</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Cruise</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Land</div>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Collect</div>
                        </div>
                        <div class="step">
                            <div class="step-number">5</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Return</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üéì Mission Briefing:</strong> 
                        <p style="margin-top: 8px;">
                            Your mission is to launch a spacecraft from Earth to <strong>{{ state.target_planet_data.name }}</strong>! 
                            To escape Earth's gravity, you need to set your <span class="tooltip-trigger">Thrust-to-Weight Ratio (TWR)<span class="tooltip">
                                <strong>What is TWR?</strong><br><br>
                                TWR compares your rocket's thrust (upward force) to its weight (downward force from gravity). 
                                If TWR = 1.0, thrust equals weight (hovering). 
                                If TWR > 1.0, you accelerate upward! üöÄ<br><br>
                                <strong>Example:</strong> If your rocket weighs 1000 kg and produces 1500 kg of thrust, TWR = 1.5!
                            </span></span>.
                        </p>
                        <p style="margin-top: 8px; font-weight: bold; color: #f8b500;">
                            ‚ö†Ô∏è TWR must be greater than 1.0 to lift off! Lower values waste fuel, higher values use fuel quickly.
                        </p>
                    </div>
                    
                    <!-- Pre-Launch Visualization -->
                    {% if state.target_planet_data %}
                    <div style="margin: 25px 0; padding: 25px; background: rgba(0, 0, 0, 0.4); border-radius: 20px; border: 3px solid rgba(248, 181, 0, 0.3);">
                        <div style="text-align: center; margin-bottom: 15px; font-family: 'Orbitron', sans-serif; color: #f8b500; font-size: 1.3em; font-weight: bold;">
                            üöÄ Launch Preparation
                        </div>
                        <div id="launch-visualization" style="position: relative; width: 100%; height: 300px; background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%); border-radius: 15px; overflow: hidden; border: 2px solid rgba(248, 181, 0, 0.2);">
                            <svg id="launch-svg" width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
                                <!-- Launch visualization will be drawn here -->
                            </svg>
                            <!-- Earth -->
                            <div id="launch-earth" style="position: absolute; left: 50%; bottom: 20px; transform: translateX(-50%); font-size: 4em; z-index: 10; filter: drop-shadow(0 0 15px rgba(100, 200, 255, 0.8));">üåç</div>
                            <!-- Rocket on launch pad -->
                            <div id="launch-rocket" style="position: absolute; left: 50%; bottom: 60px; transform: translateX(-50%); font-size: 2.5em; z-index: 15; filter: drop-shadow(0 0 20px rgba(248, 181, 0, 1));">üöÄ</div>
                            <!-- Target Planet in distance -->
                            <div id="launch-target" style="position: absolute; right: 30px; top: 30px; font-size: 2.5em; z-index: 10; filter: drop-shadow(0 0 15px rgba(100, 255, 218, 0.8));">{{ state.target_planet_data.icon }}</div>
                            <!-- Label -->
                            <div style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-family: 'Orbitron', sans-serif; color: #f8b500; font-size: 1em; font-weight: bold; text-shadow: 0 0 10px rgba(248, 181, 0, 0.8); z-index: 20;">
                                Destination: {{ state.target_planet_data.name }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Educational Concept Box -->
                    <div class="concept-box">
                        <div class="concept-box-title">üß† Science Concept: Newton's Laws</div>
                        <div class="concept-box-content">
                            <strong>Newton's 2nd Law:</strong> Force = Mass √ó Acceleration<br>
                            Your rocket needs enough force (thrust) to overcome Earth's gravity (9.8 m/s¬≤). 
                            The TWR tells you if you have enough power! Higher TWR = faster acceleration, but more fuel used.
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('launch') }}" style="display: flex; flex-direction: column; flex: 1;">
                        <div class="form-group">
                            <label for="thrust_twr">
                                Thrust-to-Weight Ratio (TWR)
                                <span class="tooltip-trigger" style="margin-left: 5px;">
                                    ‚ÑπÔ∏è
                                    <span class="tooltip">
                                        <strong>How to Choose TWR:</strong><br><br>
                                        ‚Ä¢ <strong>1.0-1.2:</strong> Very slow, uses lots of fuel fighting gravity<br>
                                        ‚Ä¢ <strong>1.2-1.8:</strong> Efficient! Good balance ‚≠ê<br>
                                        ‚Ä¢ <strong>1.8-2.5:</strong> Fast but uses more fuel<br>
                                        ‚Ä¢ <strong>2.5+:</strong> Very fast but wasteful<br><br>
                                        <strong>For {{ state.target_planet_data.name }}:</strong> 
                                        {% if state.target_planet_data.gravityFactor > 2.0 %}
                                        This planet has HIGH gravity! You'll need more fuel for landing, so be efficient now (1.2-1.5).
                                        {% elif state.target_planet_data.simDistanceKm > 3000000000 %}
                                        This is a LONG journey! Conserve fuel (1.2-1.6).
                                        {% else %}
                                        Standard mission - aim for 1.3-1.8 for best results!
                                        {% endif %}
                                    </span>
                                </span>
                            </label>
                            <input type="range" id="thrust_twr" name="thrust_twr" min="1.0" max="3.5" step="0.1" value="1.5" required>
                            <div style="text-align: center; margin-top: 10px;">
                                <span id="thrust-value" style="font-family: 'Orbitron', sans-serif; font-size: 2em; color: #f8b500; text-shadow: 0 0 20px rgba(248, 181, 0, 0.8);">1.5</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85em; color: #b0bec5;">
                                <span>Too Low</span>
                                <span style="color: #00e676;">Optimal</span>
                                <span>Too High</span>
                            </div>
                            <div class="input-hint">üí° Tip: Aim for 1.2-2.0 for optimal launch efficiency!</div>
                        </div>
                        
                        <!-- Learn More Section -->
                        <div class="learn-more" onclick="this.classList.toggle('expanded')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #64ffda;">üìö Learn More About Launching</strong>
                                <span style="color: #64ffda; font-size: 1.2em;">‚ñº</span>
                            </div>
                            <div class="learn-more-content">
                                <div class="edu-card">
                                    <div class="edu-card-title">üåç Earth's Gravity</div>
                                    <div class="edu-card-content">
                                        Earth's gravity pulls everything down at 9.8 m/s¬≤. To escape, your rocket must produce more upward force than the downward pull of gravity. That's why TWR > 1.0 is essential!
                                    </div>
                                </div>
                                <div class="edu-card">
                                    <div class="edu-card-title">‚õΩ Fuel Management</div>
                                    <div class="edu-card-content">
                                        Every second of high thrust burns fuel. If you use too much fuel during launch, you won't have enough for the long journey ahead or for landing! Balance is key! üéØ
                                    </div>
                                </div>
                                <div class="edu-card">
                                    <div class="edu-card-title">üöÄ Real Rocket Science</div>
                                    <div class="edu-card-content">
                                        Real rockets like the Saturn V had TWR around 1.2-1.5 at liftoff. Too high and the rocket shakes apart. Too low and it can't escape gravity. You're learning real engineering! üéì
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn">
                            <span>üöÄ LAUNCH ROCKET!</span>
                        </button>
                    </form>
                </div>

                {% elif state.status == 'CRUISING' %}
                <button class="help-btn" onclick="openAiTutor('What is a mid-course correction burn and why do we need it in space travel?')" title="Get Help">?</button>
                <div class="control-panel-content">
                    <h2 class="control-title">üåå Phase 2: Deep Space Cruise</h2>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Launch</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">2</div>
                            <div style="font-size: 0.85em; color: #64ffda;">Cruise</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Land</div>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Collect</div>
                        </div>
                        <div class="step">
                            <div class="step-number">5</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Return</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üìç Mission Status:</strong> 
                        <p style="margin-top: 8px;">
                            You're cruising through space! Distance remaining: <strong>{{ (state.target_distance_km - state.altitude_km) | round(0) | int }} km</strong><br>
                            Current speed: <strong>{{ state.velocity_km_s | round(2) }} km/s</strong>
                        </p>
                    </div>
                    
                    <!-- 2D Trajectory Visualization -->
                    {% if state.target_planet_data %}
                    <div style="margin: 25px 0; padding: 25px; background: rgba(0, 0, 0, 0.4); border-radius: 20px; border: 3px solid rgba(100, 255, 218, 0.3);">
                        <div style="text-align: center; margin-bottom: 15px; font-family: 'Orbitron', sans-serif; color: #64ffda; font-size: 1.3em; font-weight: bold;">
                            üõ∞Ô∏è Mission Trajectory
                        </div>
                        <div id="trajectory-container" style="position: relative; width: 100%; height: 300px; background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%); border-radius: 15px; overflow: hidden; border: 2px solid rgba(100, 255, 218, 0.2);">
                            <svg id="trajectory-svg" width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
                                <!-- Trajectory path will be drawn here -->
                            </svg>
                            <!-- Earth -->
                            <div id="earth-marker" style="position: absolute; left: 30px; top: 50%; transform: translateY(-50%); font-size: 3em; z-index: 10; filter: drop-shadow(0 0 15px rgba(100, 200, 255, 0.8));">üåç</div>
                            <!-- Rocket -->
                            <div id="rocket-marker" style="position: absolute; font-size: 2.5em; z-index: 15; filter: drop-shadow(0 0 20px rgba(248, 181, 0, 1)); transition: all 0.5s ease-out;">üöÄ</div>
                            <!-- Target Planet -->
                            <div id="planet-marker" style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); font-size: 3em; z-index: 10; filter: drop-shadow(0 0 15px rgba(100, 255, 218, 0.8));">{{ state.target_planet_data.icon }}</div>
                            <!-- Progress label -->
                            <div id="progress-label" style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-family: 'Orbitron', sans-serif; color: #64ffda; font-size: 1.1em; font-weight: bold; text-shadow: 0 0 10px rgba(100, 255, 218, 0.8); z-index: 20;">
                                {{ ((state.altitude_km / state.target_distance_km) * 100) | round }}% Complete
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="concept-box">
                        <div class="concept-box-title">üß† Science Concept: Inertia & Course Corrections</div>
                        <div class="concept-box-content">
                            In space, objects keep moving (Newton's 1st Law: Inertia). Small burns can adjust your path. 
                            Too much burn = faster but wastes fuel. Too little = slower journey. Find the balance! ‚öñÔ∏è
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('cruise') }}" style="display: flex; flex-direction: column; flex: 1;">
                        <div class="form-group">
                            <label for="burn_duration">
                                Mid-Course Correction Burn (seconds)
                                <span class="tooltip-trigger" style="margin-left: 5px;">
                                    ‚ÑπÔ∏è
                                    <span class="tooltip">
                                        <strong>What is a Mid-Course Correction?</strong><br><br>
                                        In space, small adjustments keep you on target! A "burn" fires your engines briefly to:<br>
                                        ‚Ä¢ Speed up (if you're going too slow)<br>
                                        ‚Ä¢ Slow down (if you're going too fast)<br>
                                        ‚Ä¢ Adjust direction (if you're off course)<br><br>
                                        <strong>Think of it like:</strong> Steering a car, but in 3D space! üöó‚ÜíüöÄ
                                    </span>
                                </span>
                            </label>
                            <input type="range" id="burn_duration" name="burn_duration" min="0" max="60" step="1" value="15" required>
                            <div style="text-align: center; margin-top: 10px;">
                                <span id="burn-value" style="font-family: 'Orbitron', sans-serif; font-size: 2em; color: #f8b500; text-shadow: 0 0 20px rgba(248, 181, 0, 0.8);">15</span> seconds
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85em; color: #b0bec5;">
                                <span>No Burn</span>
                                <span style="color: #00e676;">Moderate</span>
                                <span>Long Burn</span>
                            </div>
                            <div class="input-hint">üí° Tip: Balance speed and fuel conservation! Each second burns fuel.</div>
                        </div>
                        
                        <div class="learn-more" onclick="this.classList.toggle('expanded')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #64ffda;">üìö Learn More About Space Travel</strong>
                                <span style="color: #64ffda; font-size: 1.2em;">‚ñº</span>
                            </div>
                            <div class="learn-more-content">
                                <div class="edu-card">
                                    <div class="edu-card-title">üåå Deep Space</div>
                                    <div class="edu-card-content">
                                        In space, there's no air resistance! Once you're moving, you keep moving (unless you burn fuel to change). 
                                        This is why space travel is so efficient - but you need to plan your burns carefully!
                                    </div>
                                </div>
                                <div class="edu-card">
                                    <div class="edu-card-title">‚è±Ô∏è Time in Space</div>
                                    <div class="edu-card-content">
                                        Space missions take days, weeks, or even months! Each "cruise step" represents 10 days of travel. 
                                        Real missions to Mars take 6-9 months! ü™ê
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn">
                            <span>‚è±Ô∏è Continue Cruise (10 Days)</span>
                        </button>
                    </form>
                </div>

                {% elif state.status == 'LANDING_PREP' %}
                <button class="help-btn" onclick="openAiTutor('How do rockets slow down for landing? What is a retro-burn?')" title="Get Help">?</button>
                <div class="control-panel-content">
                    <h2 class="control-title">ü™ê Phase 3: Landing Sequence</h2>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Launch</div>
                        </div>
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Cruise</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">3</div>
                            <div style="font-size: 0.85em; color: #64ffda;">Land</div>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Collect</div>
                        </div>
                        <div class="step">
                            <div class="step-number">5</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Return</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>‚ö†Ô∏è Critical Landing Phase:</strong> 
                        <p style="margin-top: 8px;">
                            You're approaching <strong>{{ state.target_planet_data.name }}</strong>!<br>
                            Current velocity: <strong style="color: #ff6b9d;">{{ state.velocity_km_s | round(2) }} km/s</strong><br>
                            <strong style="color: #00e676;">Target:</strong> Less than <strong>0.15 km/s</strong> for safe landing! üõ∏<br><br>
                            <strong>Planet Info:</strong> Gravity = {{ (0.0005 * state.target_planet_data.gravityFactor * 1000) | round(2) }} m/s¬≤
                            {% if state.target_planet_data.atmosphereDrag > 1.5 %}
                            | <span style="color: #f8b500;">High Atmosphere</span> (helps slow you down!)
                            {% elif state.target_planet_data.atmosphereDrag < 0.5 %}
                            | <span style="color: #ff6b9d;">Low Atmosphere</span> (you need more retro-burn!)
                            {% endif %}
                        </p>
                    </div>
                    
                    <!-- Landing Visualization -->
                    {% if state.target_planet_data %}
                    <div style="margin: 25px 0; padding: 25px; background: rgba(0, 0, 0, 0.4); border-radius: 20px; border: 3px solid rgba(255, 107, 157, 0.3);">
                        <div style="text-align: center; margin-bottom: 15px; font-family: 'Orbitron', sans-serif; color: #ff6b9d; font-size: 1.3em; font-weight: bold;">
                            üõ∏ Landing Approach
                        </div>
                        <div id="landing-visualization" style="position: relative; width: 100%; height: 300px; background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%); border-radius: 15px; overflow: hidden; border: 2px solid rgba(255, 107, 157, 0.2);">
                            <svg id="landing-svg" width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
                                <!-- Landing trajectory will be drawn here -->
                            </svg>
                            <!-- Target Planet -->
                            <div id="landing-planet" style="position: absolute; right: 30px; bottom: 20px; font-size: 4em; z-index: 10; filter: drop-shadow(0 0 15px rgba(100, 255, 218, 0.8));">{{ state.target_planet_data.icon }}</div>
                            <!-- Rocket approaching -->
                            <div id="landing-rocket" style="position: absolute; font-size: 2.5em; z-index: 15; filter: drop-shadow(0 0 20px rgba(255, 107, 157, 1)); transition: all 0.5s ease-out;">üöÄ</div>
                            <!-- Velocity indicator -->
                            <div id="velocity-indicator" style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-family: 'Orbitron', sans-serif; color: #ff6b9d; font-size: 1.1em; font-weight: bold; text-shadow: 0 0 10px rgba(255, 107, 157, 0.8); z-index: 20;">
                                Velocity: {{ state.velocity_km_s | round(2) }} km/s
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="concept-box">
                        <div class="concept-box-title">üß† Science Concept: Deceleration & Landing</div>
                        <div class="concept-box-content">
                            To land safely, you must slow down! A <strong>retro-burn</strong> fires engines in the opposite direction of travel, 
                            like putting on brakes in a car. Too little = crash! Too much = waste fuel or overshoot! 
                            The planet's atmosphere can also help slow you down (like air resistance). üõë
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('land') }}" style="display: flex; flex-direction: column; flex: 1;">
                        <div class="form-group">
                            <label for="burn_duration">
                                Retro-Burn Duration (seconds)
                                <span class="tooltip-trigger" style="margin-left: 5px;">
                                    ‚ÑπÔ∏è
                                    <span class="tooltip">
                                        <strong>What is a Retro-Burn?</strong><br><br>
                                        A retro-burn fires your engines <strong>backward</strong> to slow down!<br><br>
                                        <strong>Think of it like:</strong> Throwing a ball forward, then throwing another ball backward to slow it down! ‚öæ‚Üê‚öæ<br><br>
                                        <strong>Current Speed:</strong> {{ state.velocity_km_s | round(2) }} km/s<br>
                                        <strong>Need:</strong> < 0.15 km/s for safe landing<br>
                                        <strong>Difference:</strong> {{ (state.velocity_km_s - 0.15) | round(2) }} km/s to slow down!<br><br>
                                        <strong>Tip:</strong> Each second of burn reduces velocity by ~0.5-0.8 km/s depending on the planet!
                                    </span>
                                </span>
                            </label>
                            <input type="range" id="burn_duration" name="burn_duration" min="0" max="30" step="1" value="5" required>
                            <div style="text-align: center; margin-top: 10px;">
                                <span id="burn-value" style="font-family: 'Orbitron', sans-serif; font-size: 2em; color: #f8b500; text-shadow: 0 0 20px rgba(248, 181, 0, 0.8);">5</span> seconds
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85em; color: #b0bec5;">
                                <span>Too Short</span>
                                <span style="color: #00e676;">Just Right</span>
                                <span>Too Long</span>
                            </div>
                            <div class="input-hint">
                                üí° Tip: 
                                {% if state.velocity_km_s > 3 %}
                                Your velocity is HIGH ({{ state.velocity_km_s | round(2) }} km/s) - try 8-15 seconds of burn!
                                {% elif state.velocity_km_s > 1.5 %}
                                Your velocity is moderate ({{ state.velocity_km_s | round(2) }} km/s) - try 5-10 seconds!
                                {% else %}
                                Your velocity is low ({{ state.velocity_km_s | round(2) }} km/s) - try 3-6 seconds!
                                {% endif %}
                                Each second reduces velocity by ~0.5-0.8 km/s.
                            </div>
                        </div>
                        
                        <div class="learn-more" onclick="this.classList.toggle('expanded')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #64ffda;">üìö Learn More About Landing</strong>
                                <span style="color: #64ffda; font-size: 1.2em;">‚ñº</span>
                            </div>
                            <div class="learn-more-content">
                                <div class="edu-card">
                                    <div class="edu-card-title">üõ∏ Landing Challenges</div>
                                    <div class="edu-card-content">
                                        Landing on another planet is one of the hardest parts of space travel! 
                                        You're moving super fast and need to slow down precisely. Too fast = crash! 
                                        Too slow = waste fuel. Real missions use computers to calculate the perfect burn! ü§ñ
                                    </div>
                                </div>
                                <div class="edu-card">
                                    <div class="edu-card-title">üåç Real Examples</div>
                                    <div class="edu-card-content">
                                        ‚Ä¢ <strong>Mars Rovers:</strong> Used parachutes AND retro-rockets!<br>
                                        ‚Ä¢ <strong>Apollo Moon Landing:</strong> Astronauts manually controlled the landing burn!<br>
                                        ‚Ä¢ <strong>SpaceX:</strong> Uses computer-controlled precision landing!<br>
                                        You're doing what real astronauts do! üöÄ
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-danger">
                            <span>üõ∏ EXECUTE LANDING BURN</span>
                        </button>
                    </form>
                </div>

                {% elif state.status == 'SURFACE_DATA' %}
                <button class="help-btn" onclick="openAiTutor('What kind of scientific data do we collect on other planets and why is it important?')" title="Get Help">?</button>
                <div class="control-panel-content">
                    <h2 class="control-title">üî¨ Phase 4: Data Collection</h2>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Launch</div>
                        </div>
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Cruise</div>
                        </div>
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Land</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">4</div>
                            <div style="font-size: 0.85em; color: #64ffda;">Collect</div>
                        </div>
                        <div class="step">
                            <div class="step-number">5</div>
                            <div style="font-size: 0.85em; color: #b0bec5;">Return</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong>üéâ Landing Successful!</strong> 
                        <p style="margin-top: 8px;">
                            You've safely landed on <strong>{{ state.target_planet_data.name }}</strong>! üåü<br>
                            Now it's time to collect scientific data about this amazing world!
                        </p>
                    </div>
                    
                    <div class="concept-box">
                        <div class="concept-box-title">üß† Science Concept: Planetary Science</div>
                        <div class="concept-box-content">
                            Scientists study other planets to learn about our solar system, how planets form, and if life could exist elsewhere! 
                            Data collection uses instruments that need power (fuel). The more data, the more we learn! üìä
                        </div>
                    </div>
                    
                    <div class="edu-card">
                        <div class="edu-card-title">üî¨ What Data Do We Collect?</div>
                        <div class="edu-card-content">
                            ‚Ä¢ <strong>Atmosphere:</strong> What gases are present? Can we breathe?<br>
                            ‚Ä¢ <strong>Surface:</strong> Rocks, soil composition, signs of water<br>
                            ‚Ä¢ <strong>Temperature:</strong> How hot/cold is it?<br>
                            ‚Ä¢ <strong>Gravity:</strong> How strong is the pull?<br>
                            ‚Ä¢ <strong>Magnetic Field:</strong> Does it protect from radiation?<br><br>
                            This data helps us understand if humans could live there! üè†
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="edu-card" style="background: rgba(100, 255, 218, 0.15); border-color: rgba(100, 255, 218, 0.4);">
                            <div class="edu-card-title">üî¨ Optional: Atmospheric Spectroscopy</div>
                            <div class="edu-card-content">
                                Analyze light spectra to identify elements in {{ state.target_planet_data.name }}'s atmosphere!<br><br>
                                <a href="{{ url_for('spectroscopy') }}" class="btn" style="padding: 12px 25px; font-size: 1em; text-decoration: none; display: inline-block; margin-top: 10px;">
                                    üåà Start Spectroscopy
                                </a>
                                {% if state.spectroscopy_completed %}
                                <p style="color: #00e676; margin-top: 10px; font-weight: bold; font-size: 0.9em;">‚úÖ Completed! +10 data units</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="edu-card" style="background: rgba(248, 181, 0, 0.15); border-color: rgba(248, 181, 0, 0.4);">
                            <div class="edu-card-title">üî≠ Optional: Transit Photometry</div>
                            <div class="edu-card-content">
                                Measure the light curve to calculate {{ state.target_planet_data.name }}'s size relative to its star!<br><br>
                                <a href="{{ url_for('transit_photometry') }}" class="btn" style="padding: 12px 25px; font-size: 1em; text-decoration: none; display: inline-block; margin-top: 10px; background: linear-gradient(135deg, #f8b500, #ff9800);">
                                    üî≠ Start Photometry
                                </a>
                                {% if state.transit_photometry_completed %}
                                <p style="color: #00e676; margin-top: 10px; font-weight: bold; font-size: 0.9em;">‚úÖ Completed! +10 data units</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('collect') }}" style="display: flex; flex-direction: column; flex: 1; justify-content: center;">
                        <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 230, 118, 0.1); border-radius: 10px; border: 2px solid rgba(0, 230, 118, 0.3);">
                            <p style="color: #00e676; font-weight: bold; margin-bottom: 8px;">Fuel Required: 50 units</p>
                            <p style="color: #b0bec5;">Current Fuel: <strong style="color: #ffffff;">{{ state.fuel | round(0) | int }} units</strong></p>
                            {% if state.fuel < 50 %}
                            <p style="color: #ff6b9d; margin-top: 8px;">‚ö†Ô∏è Warning: Low fuel! Make sure you have enough for the return journey!</p>
                            {% else %}
                            <p style="color: #00e676; margin-top: 8px;">‚úÖ You have enough fuel!</p>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-success">
                            <span>üî¨ COLLECT DATA & PREPARE RETURN</span>
                        </button>
                    </form>
                </div>

                {% elif state.status == 'RETURN_PREP' %}
                <button class="help-btn" onclick="openAiTutor('What challenges do we face when returning from another planet to Earth?')" title="Get Help">?</button>
                <div class="control-panel-content">
                    <h2 class="control-title">üè† Phase 5: Return Home</h2>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Launch</div>
                        </div>
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Cruise</div>
                        </div>
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Land</div>
                        </div>
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div style="font-size: 0.85em; color: #00e676;">Collect</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">5</div>
                            <div style="font-size: 0.85em; color: #64ffda;">Return</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong>‚ú® Final Phase!</strong> 
                        <p style="margin-top: 8px;">
                            Data collected: <strong>{{ state.collected_data_units }} / {{ state.required_data_units }} units</strong> ‚úÖ<br>
                            Fuel remaining: <strong>{{ state.fuel | round(0) | int }} units</strong> ‚õΩ<br>
                            Ready to launch back to Earth! üöÄ
                        </p>
                    </div>
                    
                    <div class="concept-box">
                        <div class="concept-box-title">üß† Science Concept: Return Journey</div>
                        <div class="concept-box-content">
                            Returning home requires another launch from the planet's surface, then a cruise back to Earth, 
                            and finally re-entry through Earth's atmosphere! You need enough fuel for all these steps. 
                            This is why fuel management throughout the mission is so critical! ‚õΩ
                        </div>
                    </div>
                    
                    <div class="edu-card">
                        <div class="edu-card-title">üåç Earth Re-Entry</div>
                        <div class="edu-card-content">
                            When returning to Earth, spacecraft enter the atmosphere at high speed, creating intense heat from air friction. 
                            Heat shields protect the crew and data! Real missions use special materials that burn away (ablation) to protect the spacecraft. üî•
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('return_ship') }}" style="display: flex; flex-direction: column; flex: 1; justify-content: center;">
                        <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 230, 118, 0.1); border-radius: 10px; border: 2px solid rgba(0, 230, 118, 0.3);">
                            <p style="color: #00e676; font-weight: bold; margin-bottom: 8px;">Return Burn Required: 100 units</p>
                            <p style="color: #b0bec5;">Current Fuel: <strong style="color: #ffffff;">{{ state.fuel | round(0) | int }} units</strong></p>
                            {% if state.fuel < 100 %}
                            <p style="color: #ff6b9d; margin-top: 8px;">‚ö†Ô∏è Not enough fuel! Mission may fail.</p>
                            {% else %}
                            <p style="color: #00e676; margin-top: 8px;">‚úÖ You have enough fuel for return!</p>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-success">
                            <span>üåç EXECUTE RETURN LAUNCH</span>
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>

            <!-- Right Panel: Progress & Educational Content -->
            <div class="dashboard-panel">
                <div class="side-panel-title">üìä Mission Progress</div>
                
                <div class="progress-container-compact">
                    <div class="progress-label-compact">
                        <span>‚õΩ Fuel</span>
                        <span>{{ state.fuel | round(0) | int }}/{{ state.initial_fuel }}</span>
                    </div>
                    <div class="progress-bar-compact">
                        <div class="progress-fill-compact" style="width: {{ (state.fuel / state.initial_fuel * 100) | round }}%"></div>
                    </div>
                    {% if state.fuel < state.initial_fuel * 0.3 %}
                    <div style="font-size: 0.8em; color: #ff6b9d; margin-top: 5px; text-align: center;">‚ö†Ô∏è Low Fuel Warning!</div>
                    {% elif state.fuel < state.initial_fuel * 0.5 %}
                    <div style="font-size: 0.8em; color: #f8b500; margin-top: 5px; text-align: center;">üí° Fuel getting low</div>
                    {% endif %}
                </div>

                {% if state.target_planet_data %}
                <div class="progress-container-compact">
                    <div class="progress-label-compact">
                        <span>ü™ê Distance</span>
                        <span>{{ (state.target_distance_km - state.altitude_km) | round(0) | int }} km</span>
                    </div>
                    <div class="progress-bar-compact">
                        <div class="progress-fill-compact" style="width: {{ ((state.altitude_km / state.target_distance_km) * 100) | round }}%"></div>
                    </div>
                </div>
                {% endif %}

                <div class="progress-container-compact">
                    <div class="progress-label-compact">
                        <span>üî¨ Data</span>
                        <span>{{ state.collected_data_units }}/{{ state.required_data_units }}</span>
                    </div>
                    <div class="progress-bar-compact">
                        <div class="progress-fill-compact" style="width: {{ (state.collected_data_units / state.required_data_units * 100) | round }}%"></div>
                    </div>
                </div>

                <!-- Distance Visualization -->
                {% if state.status == 'CRUISING' and state.target_planet_data %}
                <div style="margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border: 2px solid rgba(100, 200, 255, 0.3);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="font-size: 2em;">üåç</div>
                        <div style="flex: 1; height: 4px; background: linear-gradient(90deg, #64ffda, transparent); margin: 0 15px; position: relative; border-radius: 10px;">
                            <div style="position: absolute; left: {{ ((state.altitude_km / state.target_distance_km) * 100) | round }}%; top: 50%; transform: translateY(-50%); font-size: 1.5em; transition: left 1s ease-out;">üöÄ</div>
                        </div>
                        <div style="font-size: 2em;">{{ state.target_planet_data.icon }}</div>
                    </div>
                    <div style="text-align: center; font-size: 0.9em; color: #64ffda;">
                        {{ ((state.altitude_km / state.target_distance_km) * 100) | round }}% Complete
                    </div>
                </div>
                {% endif %}
                
                <!-- Educational Quick Facts -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(100, 255, 218, 0.1); border-radius: 12px; border: 2px solid rgba(100, 255, 218, 0.3);">
                    <div class="side-panel-title" style="font-size: 1.1em; margin-bottom: 12px;">üåü Quick Facts</div>
                    {% if state.status == 'PRE_LAUNCH' %}
                    <div class="edu-card-content" style="font-size: 0.9em;">
                        <strong>üöÄ Launch Facts:</strong><br>
                        ‚Ä¢ Earth's escape velocity: 11.2 km/s<br>
                        ‚Ä¢ Real rockets use multiple stages<br>
                        ‚Ä¢ Fuel is 90% of rocket weight!<br>
                        ‚Ä¢ TWR must be > 1.0 to lift off
                    </div>
                    {% elif state.status == 'CRUISING' %}
                    <div class="edu-card-content" style="font-size: 0.9em;">
                        <strong>üåå Space Travel Facts:</strong><br>
                        ‚Ä¢ No air resistance in space!<br>
                        ‚Ä¢ Objects keep moving (inertia)<br>
                        ‚Ä¢ Mars trip: 6-9 months<br>
                        ‚Ä¢ Speed of light: 300,000 km/s
                    </div>
                    {% elif state.status == 'LANDING_PREP' %}
                    <div class="edu-card-content" style="font-size: 0.9em;">
                        <strong>ü™ê Landing Facts:</strong><br>
                        ‚Ä¢ Landing is the hardest part!<br>
                        ‚Ä¢ Atmosphere helps slow down<br>
                        ‚Ä¢ Need precise velocity control<br>
                        ‚Ä¢ Real missions use computers
                    </div>
                    {% elif state.status == 'SURFACE_DATA' %}
                    <div class="edu-card-content" style="font-size: 0.9em;">
                        <strong>üî¨ Science Facts:</strong><br>
                        ‚Ä¢ We study planets for life signs<br>
                        ‚Ä¢ Data helps plan future missions<br>
                        ‚Ä¢ Each planet is unique!<br>
                        ‚Ä¢ Science needs power (fuel)
                    </div>
                    {% elif state.status == 'RETURN_PREP' %}
                    <div class="edu-card-content" style="font-size: 0.9em;">
                        <strong>üè† Return Facts:</strong><br>
                        ‚Ä¢ Need fuel for launch + cruise<br>
                        ‚Ä¢ Earth re-entry is very hot!<br>
                        ‚Ä¢ Heat shields protect data<br>
                        ‚Ä¢ Precision is critical!
                    </div>
                    {% endif %}
                </div>
                
                <!-- Planet Info Card -->
                {% if state.target_planet_data %}
                <div style="margin-top: 15px; padding: 15px; background: rgba(248, 181, 0, 0.1); border-radius: 12px; border: 2px solid rgba(248, 181, 0, 0.3);">
                    <div style="font-weight: bold; color: #f8b500; margin-bottom: 10px; font-size: 1.1em;">ü™ê {{ state.target_planet_data.name }}</div>
                    <div style="font-size: 0.85em; color: #b0bec5; line-height: 1.6;">
                        <strong>Type:</strong> {{ state.target_planet_data.type }}<br>
                        <strong>Distance:</strong> {{ state.target_planet_data.distance }}<br>
                        <strong>Gravity:</strong> {{ (0.0005 * state.target_planet_data.gravityFactor * 1000) | round(2) }} m/s¬≤<br>
                        <strong>Focus:</strong> {{ state.target_planet_data.focus }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Selection Screen - Always show when status is SELECTION -->
        {% if state.status == 'SELECTION' %}
        <div style="flex: 1; overflow-y: auto; width: 100%;">
            <div class="status-card" style="max-width: 1400px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <h2 style="font-family: 'Orbitron', sans-serif; color: #64ffda; margin-bottom: 20px; font-size: 3em; text-shadow: 0 0 30px rgba(100, 255, 218, 0.8); animation: pulse 2s infinite;">
                        üåå Choose Your Mission Destination üåå
                    </h2>
                <p style="font-size: 1.5em; color: #ffffff; margin-bottom: 15px; font-weight: 600;">
                    Welcome, {% if space_name %}{{ space_name }}{% else %}Future Astronaut{% endif %}! üöÄ
                </p>
                <p style="text-align: center; font-size: 1.3em; color: #b0bec5; margin-bottom: 20px; line-height: 1.6;">
                    Pick an amazing exoplanet to explore! Each mission teaches you different space science concepts!<br>
                    Learn about gravity, propulsion, orbital mechanics, and more! üåü
                </p>
                
                <!-- Quick Start Guide -->
                <div class="learn-more" onclick="this.classList.toggle('expanded')" style="max-width: 800px; margin: 0 auto 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="color: #64ffda; font-size: 1.2em;">üìñ How to Navigate</strong>
                        <span style="color: #64ffda; font-size: 1.5em;">‚ñº</span>
                    </div>
                    <div class="learn-more-content">
                        <div class="edu-card">
                            <div class="edu-card-title">üéØ Your Mission</div>
                            <div class="edu-card-content">
                                <strong>Goal:</strong> Launch from Earth ‚Üí Travel to another planet ‚Üí Land safely ‚Üí Collect data ‚Üí Return home!<br><br>
                                <strong>5 Phases:</strong><br>
                                1Ô∏è‚É£ <strong>Launch:</strong> Set TWR to escape Earth's gravity<br>
                                2Ô∏è‚É£ <strong>Cruise:</strong> Travel through space (use burns to adjust)<br>
                                3Ô∏è‚É£ <strong>Land:</strong> Slow down with retro-burn for safe landing<br>
                                4Ô∏è‚É£ <strong>Collect:</strong> Gather scientific data on the surface<br>
                                5Ô∏è‚É£ <strong>Return:</strong> Launch back to Earth with your data!<br><br>
                                <strong>üí° Tip:</strong> Watch your fuel! You need it for every phase!
                            </div>
                        </div>
                        <div class="edu-card">
                            <div class="edu-card-title">ü§ñ Get Help Anytime</div>
                            <div class="edu-card-content">
                                ‚Ä¢ Click the <strong>ü§ñ AI Tutor button</strong> (bottom right) to ask questions!<br>
                                ‚Ä¢ Hover over <strong>‚ÑπÔ∏è info icons</strong> for quick explanations<br>
                                ‚Ä¢ Click <strong>üìö Learn More</strong> sections for detailed info<br>
                                ‚Ä¢ Use the <strong>? Help button</strong> in each phase for context-specific help!<br><br>
                                SABRINA (the AI tutor) is always ready to explain space science concepts!
                            </div>
                        </div>
                        <div class="edu-card">
                            <div class="edu-card-title">üéì What You'll Learn</div>
                            <div class="edu-card-content">
                                ‚Ä¢ <strong>Physics:</strong> Newton's Laws, gravity, acceleration, inertia<br>
                                ‚Ä¢ <strong>Engineering:</strong> Fuel management, thrust, efficiency<br>
                                ‚Ä¢ <strong>Space Science:</strong> Orbital mechanics, planetary science<br>
                                ‚Ä¢ <strong>Problem Solving:</strong> Planning, decision-making, resource management<br><br>
                                Each planet teaches different concepts - try them all!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px;">
                {% for key, planet in exoplanets.items() %}
                <form action="{{ url_for('select_planet_route') }}" method="post" style="height: 100%;">
                    <input type="hidden" name="planet_key" value="{{ key }}">
                    <button type="submit" class="w-full h-full text-left p-0 border-none bg-transparent" style="height: 100%;">
                        <div class="planet-card" style="height: 100%; display: flex; flex-direction: column;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div class="planet-icon" style="font-size: 6em;">{{ planet.icon }}</div>
                            </div>
                            <h3 style="font-family: 'Orbitron', sans-serif; font-size: 2em; font-weight: bold; color: white; margin-bottom: 15px; text-align: center; text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);">{{ planet.name }}</h3>
                            <p style="font-size: 1.4em; font-weight: 600; color: #64ffda; margin-bottom: 20px; text-align: center; text-shadow: 0 0 15px rgba(100, 255, 218, 0.6);">{{ planet.type }}</p>
                            <div style="color: #b0bec5; line-height: 2; flex-grow: 1; padding: 0 10px;">
                                <p style="font-size: 1.1em; margin-bottom: 10px;">
                                    <strong style="color: #64ffda; font-size: 1.2em;">üìç Distance:</strong><br>
                                    <span style="font-size: 1.1em;">{{ planet.distance }}</span>
                                    <span class="tooltip-trigger" style="margin-left: 5px; font-size: 0.9em;">
                                        ‚ÑπÔ∏è
                                        <span class="tooltip" style="width: 250px;">
                                            <strong>Why Distance Matters:</strong><br><br>
                                            Longer distances mean:<br>
                                            ‚Ä¢ More time in space<br>
                                            ‚Ä¢ More fuel needed for cruise<br>
                                            ‚Ä¢ Need to be more efficient!<br><br>
                                            Real space missions take months or years!
                                        </span>
                                    </span>
                                </p>
                                <p style="font-size: 1.1em; margin-bottom: 15px;">
                                    <strong style="color: #f8b500; font-size: 1.2em;">üéØ Learning Focus:</strong><br>
                                    <span style="font-size: 1.1em;">{{ planet.focus }}</span>
                                    <span class="tooltip-trigger" style="margin-left: 5px; font-size: 0.9em;">
                                        ‚ÑπÔ∏è
                                        <span class="tooltip" style="width: 250px;">
                                            <strong>What You'll Learn:</strong><br><br>
                                            Each planet focuses on different space science concepts. 
                                            This mission will teach you about {{ planet.focus.lower() }} through hands-on experience!<br><br>
                                            Try different planets to learn different concepts!
                                        </span>
                                    </span>
                                </p>
                                {% if planet.description %}
                                <p style="margin-top: 15px; font-size: 1em; font-style: italic; color: #d0d0d0;">
                                    {{ planet.description }}
                                </p>
                                {% else %}
                                <p style="margin-top: 15px; font-size: 1em; font-style: italic; color: #d0d0d0;">
                                    {% if key == 'Aetheria' %}
                                    A mysterious frozen moon with unique orbital challenges. Perfect for learning about navigation and scale!
                                    {% elif key == 'TerraNova' %}
                                    A massive super-Earth with intense gravity. Master thrust and escape velocity here!
                                    {% elif key == 'Kyperus' %}
                                    An ocean world with dense atmosphere. Learn about atmospheric drag and pressure!
                                    {% endif %}
                                </p>
                                {% endif %}
                            </div>
                            <div class="launch-button" style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #00e676, #00bcd4); border-radius: 15px; text-align: center; font-weight: bold; font-size: 1.4em; color: white; box-shadow: 0 8px 25px rgba(0, 230, 118, 0.5); transition: all 0.3s; transform: scale(1); position: relative; overflow: hidden;">
                                <span style="position: relative; z-index: 1;">üöÄ Launch Mission! üöÄ</span>
                            </div>
                        </div>
                    </button>
                </form>
                {% endfor %}
            </div>
            
            <div style="text-align: center; margin-top: 40px; padding: 20px; background: rgba(100, 255, 218, 0.1); border-radius: 15px; border: 2px solid rgba(100, 255, 218, 0.3);">
                <p style="font-size: 1.2em; color: #64ffda;">
                    üí° <strong>Tip:</strong> Click on any planet card above to start your mission! Each planet offers unique challenges and learning opportunities!
                </p>
            </div>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- AI Tutor Button -->
    {% if state.target_planet_data %}
    <button id="ai-tutor-button" onclick="openAiTutor()" class="ai-tutor-btn">
        ü§ñ
    </button>
    {% endif %}

    <!-- AI Tutor Modal -->
    <div id="ai-tutor-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center p-4" style="backdrop-filter: blur(10px);">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl h-full max-h-[85vh] flex flex-col border-4 border-indigo-500">
            <div class="flex justify-between items-center p-5 border-b-4 border-gray-700 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-t-xl">
                <h2 class="text-3xl font-bold text-white">ü§ñ SABRINA: Your AI Mission Tutor</h2>
                <button onclick="closeAiTutor()" class="text-white hover:text-red-400 p-2 rounded-full hover:bg-red-500 transition" style="font-size: 1.5em;">‚úï</button>
            </div>
            <div id="ai-tutor-output" class="flex-grow p-5 space-y-4 overflow-y-auto flex flex-col bg-gray-800">
                <div class="mb-3 p-4 rounded-xl bg-emerald-900/50 self-start max-w-md border-2 border-emerald-500">
                    <strong>ü§ñ SABRINA:</strong> Hi there, future astronaut! üëã I'm SABRINA, your AI Mission Tutor. Ask me anything about space, gravity, rockets, or your current mission! I'm here to help you learn! üöÄ‚ú®
                </div>
            </div>
            <div id="ai-tutor-loading" class="text-center p-3 hidden bg-gray-700">
                <p class="text-indigo-400 animate-pulse font-bold">üåü SABRINA is thinking... üåü</p>
            </div>
            <div class="p-5 border-t-4 border-gray-700 flex gap-3 bg-gray-800 rounded-b-xl">
                <input type="text" id="ai-tutor-input" placeholder="Ask SABRINA a question..." 
                    class="flex-grow p-4 rounded-xl bg-gray-700 text-white border-2 border-gray-600 focus:outline-none focus:ring-4 focus:ring-indigo-500 text-lg"
                    onkeydown="if(event.key === 'Enter') handleAiQuery()">
                <button onclick="handleAiQuery()" class="p-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-xl text-white font-bold transition text-lg">
                    Send üöÄ
                </button>
            </div>
        </div>
    </div>

    <script>
        // Create animated starfield
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const numStars = 150;
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 4 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                starsContainer.appendChild(star);
            }
        }

        // Slider value updates with visual feedback
        document.addEventListener('DOMContentLoaded', function() {
            createStars();
            
            const thrustSlider = document.getElementById('thrust_twr');
            const burnSliders = document.querySelectorAll('input[name="burn_duration"]');
            
            if (thrustSlider) {
                thrustSlider.addEventListener('input', (e) => {
                    const valueDisplay = document.getElementById('thrust-value');
                    if (valueDisplay) {
                        const value = parseFloat(e.target.value);
                        valueDisplay.textContent = value;
                        
                        // Visual feedback based on TWR value
                        if (value >= 1.2 && value <= 1.8) {
                            valueDisplay.style.color = '#00e676'; // Green for optimal
                            valueDisplay.style.textShadow = '0 0 20px rgba(0, 230, 118, 0.8)';
                        } else if (value < 1.2) {
                            valueDisplay.style.color = '#f8b500'; // Yellow for low
                            valueDisplay.style.textShadow = '0 0 20px rgba(248, 181, 0, 0.8)';
                        } else {
                            valueDisplay.style.color = '#ff6b9d'; // Pink for high
                            valueDisplay.style.textShadow = '0 0 20px rgba(255, 107, 157, 0.8)';
                        }
                    }
                });
            }
            
            burnSliders.forEach((slider) => {
                slider.addEventListener('input', (e) => {
                    const valueDisplay = document.getElementById('burn-value');
                    if (valueDisplay) {
                        const value = parseInt(e.target.value);
                        valueDisplay.textContent = value;
                        
                        // Pulse animation for feedback
                        valueDisplay.style.animation = 'none';
                        setTimeout(() => {
                            valueDisplay.style.animation = 'pulse 0.3s ease-out';
                        }, 10);
                    }
                });
            });
            
            // Add slide-in animation to cards
            const cards = document.querySelectorAll('.status-card, .dashboard-panel, .planet-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('slide-in');
            });
            
            // Draw visualizations for different phases
            drawTrajectory();
            drawLaunchVisualization();
            drawLandingVisualization();
        });
        
        function drawTrajectory() {
            const container = document.getElementById('trajectory-container');
            const svg = document.getElementById('trajectory-svg');
            const rocket = document.getElementById('rocket-marker');
            
            if (!container || !svg || !rocket) return;
            
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            {% if state.status == 'CRUISING' and state.target_planet_data %}
            const cruiseProgress = {{ (state.altitude_km / state.target_distance_km) }};
            {% else %}
            const cruiseProgress = 0;
            {% endif %}
            
            // Clear previous path
            svg.innerHTML = '';
            
            // Calculate positions
            const cruiseStartX = 60; // Earth position (left)
            const cruiseEndX = containerWidth - 60; // Planet position (right)
            const cruiseCenterY = containerHeight / 2;
            
            // Create curved trajectory path (Hohmann transfer-like curve)
            const cruiseControlY = cruiseCenterY - 80; // Curve upward
            const cruisePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const cruisePathData = `M ${cruiseStartX} ${cruiseCenterY} Q ${(cruiseStartX + cruiseEndX) / 2} ${cruiseControlY} ${cruiseEndX} ${cruiseCenterY}`;
            cruisePath.setAttribute('d', cruisePathData);
            cruisePath.setAttribute('stroke', '#64ffda');
            cruisePath.setAttribute('stroke-width', '3');
            cruisePath.setAttribute('fill', 'none');
            cruisePath.setAttribute('stroke-dasharray', '5,5');
            cruisePath.setAttribute('opacity', '0.6');
            cruisePath.style.filter = 'drop-shadow(0 0 5px rgba(100, 255, 218, 0.5))';
            svg.appendChild(cruisePath);
            
            // Calculate rocket position along the curve
            const cruiseT = Math.min(1, Math.max(0, cruiseProgress)); // Clamp between 0 and 1
            const cruiseRocketX = cruiseStartX + (cruiseEndX - cruiseStartX) * cruiseT;
            // Quadratic curve calculation: y = (1-t)¬≤y0 + 2(1-t)ty1 + t¬≤y2
            const cruiseRocketY = cruiseCenterY * Math.pow(1 - cruiseT, 2) + cruiseControlY * 2 * (1 - cruiseT) * cruiseT + cruiseCenterY * Math.pow(cruiseT, 2);
            
            // Position rocket
            rocket.style.left = (cruiseRocketX - 20) + 'px';
            rocket.style.top = (cruiseRocketY - 20) + 'px';
            
            // Add rotation to rocket based on trajectory direction
            const cruiseAngle = Math.atan2(cruiseControlY - cruiseCenterY, (cruiseEndX - cruiseStartX) / 2) * (180 / Math.PI);
            rocket.style.transform = `rotate(${cruiseAngle * cruiseT}deg)`;
            
            // Add stars in background
            for (let i = 0; i < 20; i++) {
                const star = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                const x = Math.random() * containerWidth;
                const y = Math.random() * containerHeight;
                star.setAttribute('cx', x);
                star.setAttribute('cy', y);
                star.setAttribute('r', Math.random() * 2 + 1);
                star.setAttribute('fill', '#ffffff');
                star.setAttribute('opacity', '0.6');
                svg.appendChild(star);
            }
        }
        
        function drawLaunchVisualization() {
            const container = document.getElementById('launch-visualization');
            const svg = document.getElementById('launch-svg');
            
            if (!container || !svg) return;
            
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            
            // Clear previous
            svg.innerHTML = '';
            
            // Draw escape trajectory arc (from Earth upward and outward)
            const launchEarthX = containerWidth / 2;
            const launchEarthY = containerHeight - 60;
            const launchTargetX = containerWidth - 60;
            const launchTargetY = 50;
            
            // Create escape trajectory path (curved upward from Earth)
            const launchPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const launchControlX = launchEarthX + 100;
            const launchControlY = launchEarthY - 150;
            const launchPathData = `M ${launchEarthX} ${launchEarthY} Q ${launchControlX} ${launchControlY} ${launchTargetX} ${launchTargetY}`;
            launchPath.setAttribute('d', launchPathData);
            launchPath.setAttribute('stroke', '#f8b500');
            launchPath.setAttribute('stroke-width', '2');
            launchPath.setAttribute('fill', 'none');
            launchPath.setAttribute('stroke-dasharray', '5,5');
            launchPath.setAttribute('opacity', '0.5');
            launchPath.style.filter = 'drop-shadow(0 0 5px rgba(248, 181, 0, 0.5))';
            svg.appendChild(launchPath);
            
            // Add stars
            for (let i = 0; i < 15; i++) {
                const star = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                const x = Math.random() * containerWidth;
                const y = Math.random() * containerHeight;
                star.setAttribute('cx', x);
                star.setAttribute('cy', y);
                star.setAttribute('r', Math.random() * 2 + 1);
                star.setAttribute('fill', '#ffffff');
                star.setAttribute('opacity', '0.6');
                svg.appendChild(star);
            }
        }
        
        function drawLandingVisualization() {
            const container = document.getElementById('landing-visualization');
            const svg = document.getElementById('landing-svg');
            const rocket = document.getElementById('landing-rocket');
            
            if (!container || !svg || !rocket) return;
            
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            
            let landingVelocityProgress = 0;
            {% if state.status == 'LANDING_PREP' and state.target_planet_data %}
            const landingCurrentVelocity = {{ state.velocity_km_s }};
            // Calculate approach progress (inverse - higher velocity = further from planet)
            landingVelocityProgress = Math.min(1, Math.max(0, 1 - (landingCurrentVelocity / 3.0))); // Normalize to 0-3 km/s range
            {% endif %}
            
            // Clear previous
            svg.innerHTML = '';
            
            // Calculate positions
            const landingPlanetX = containerWidth - 60;
            const landingPlanetY = containerHeight - 60;
            const landingStartX = 60;
            const landingStartY = 50;
            
            // Draw landing approach trajectory (curved descent)
            const landingPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const landingControlX = (landingStartX + landingPlanetX) / 2;
            const landingControlY = containerHeight - 100;
            const landingPathData = `M ${landingStartX} ${landingStartY} Q ${landingControlX} ${landingControlY} ${landingPlanetX} ${landingPlanetY}`;
            landingPath.setAttribute('d', landingPathData);
            landingPath.setAttribute('stroke', '#ff6b9d');
            landingPath.setAttribute('stroke-width', '3');
            landingPath.setAttribute('fill', 'none');
            landingPath.setAttribute('stroke-dasharray', '5,5');
            landingPath.setAttribute('opacity', '0.6');
            landingPath.style.filter = 'drop-shadow(0 0 5px rgba(255, 107, 157, 0.5))';
            svg.appendChild(landingPath);
            
            // Calculate rocket position along the descent curve
            const landingT = Math.min(1, Math.max(0, landingVelocityProgress));
            const landingRocketX = landingStartX + (landingPlanetX - landingStartX) * landingT;
            const landingRocketY = landingStartY * Math.pow(1 - landingT, 2) + landingControlY * 2 * (1 - landingT) * landingT + landingPlanetY * Math.pow(landingT, 2);
            
            // Position rocket
            rocket.style.left = (landingRocketX - 20) + 'px';
            rocket.style.top = (landingRocketY - 20) + 'px';
            
            // Rotate rocket to follow descent path
            const landingAngle = Math.atan2(landingPlanetY - landingStartY, landingPlanetX - landingStartX) * (180 / Math.PI) + 45;
            rocket.style.transform = `rotate(${landingAngle}deg)`;
            
            // Add stars
            for (let i = 0; i < 15; i++) {
                const star = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                const x = Math.random() * containerWidth;
                const y = Math.random() * containerHeight;
                star.setAttribute('cx', x);
                star.setAttribute('cy', y);
                star.setAttribute('r', Math.random() * 2 + 1);
                star.setAttribute('fill', '#ffffff');
                star.setAttribute('opacity', '0.6');
                svg.appendChild(star);
            }
        }

        // AI Tutor Functions
        let currentStatus = '{{ state.status }}';
        let currentPlanetName = '{{ state.target_planet_data.name if state.target_planet_data else "Unknown" }}';
        const geminiModel = "gemini-2.5-flash-preview-09-2025";
        const apiKey = "{{ gemini_api_key }}";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;
        
        // Debug: Log API key status (first 10 chars only for security)
        console.log('üîë API Key Status:', apiKey ? `Set (${apiKey.substring(0, 10)}...)` : 'NOT SET');
        
        // Check if API key is set
        if (!apiKey || apiKey.trim() === '') {
            console.warn('‚ö†Ô∏è Gemini API key is not set. The AI tutor will not work. Set GEMINI_API_KEY environment variable.');
        }

        // Helper function to create a timeout promise
        function timeoutPromise(ms) {
            return new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), ms)
            );
        }

        async function getAiExplanation(prompt, systemInstruction) {
            const aiLoadingDiv = document.getElementById('ai-tutor-loading');
            aiLoadingDiv.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                // Removed google_search tool to speed up responses
            };

            const maxRetries = 2; // Reduced retries
            const timeoutMs = 15000; // 15 second timeout per request

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    // Race between fetch and timeout
                    const response = await Promise.race([
                        fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }),
                        timeoutPromise(timeoutMs)
                    ]);

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            // No text in response
                            return "I received a response but couldn't extract the text. Please try asking again!";
                        }
                    } else {
                        // Handle API errors
                        let errorData = {};
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            // If JSON parsing fails, use empty object
                        }
                        
                        if (response.status === 403 || response.status === 401) {
                            return "ERROR: Invalid API key. Please check your GEMINI_API_KEY environment variable.";
                        } else if (response.status === 429) {
                            return "ERROR: API rate limit exceeded. Please try again in a moment.";
                        } else {
                            return `ERROR: API request failed (${response.status}). ${errorData.error?.message || 'Please try again.'}`;
                        }
                    }
                } catch (error) {
                    console.warn(`Attempt ${attempt + 1} failed:`, error.message);
                    
                    // If it's a timeout or network error and we have retries left
                    if (attempt < maxRetries - 1) {
                        const waitTime = Math.min(1000 * (attempt + 1), 3000); // Max 3 seconds
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue; // Retry
                    } else {
                        // Last attempt failed
                        if (error.message === 'Request timeout') {
                            return "I'm taking too long to respond! The API might be slow right now. Please try again in a moment!";
                        } else {
                            return "I'm having trouble connecting to the space network. Please check your internet connection and try again!";
                        }
                    }
                }
            }
            
            return "I'm having trouble connecting to the space network. Please try asking again in a moment!";
        }

        async function handleAiQuery(initialPrompt = '') {
            const input = document.getElementById('ai-tutor-input');
            const query = initialPrompt || input.value.trim();
            if (!query) return;

            const systemPrompt = `You are SABRINA, an AI Mission Tutor for middle school students (grades 6-8). Your tone must be encouraging, enthusiastic, clear, and fun! Use emojis sometimes. Your goal is to explain complex physics and space concepts related to the current mission phase (${currentStatus}) and the selected planet (${currentPlanetName}). Use analogies and simple terms. Keep answers concise but engaging. Be like a friendly science teacher!`;
            
            const prompt = `The student is currently in the ${currentStatus} phase of the mission to ${currentPlanetName}. The student asked: "${query}"`;

            const outputDiv = document.getElementById('ai-tutor-output');
            outputDiv.innerHTML += `<div class="mb-3 p-4 rounded-xl bg-blue-900/50 self-end max-w-md border-2 border-blue-500"><strong>üßë‚ÄçüöÄ You:</strong> ${query}</div>`;
            if (!initialPrompt) input.value = ''; 
            
            outputDiv.innerHTML += `<div id="ai-response-temp" class="mb-3 p-4 rounded-xl bg-gray-700/50 self-start max-w-md border-2 border-gray-600"><strong>ü§ñ SABRINA:</strong> Thinking...</div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;

            let responseText;
            try {
                responseText = await getAiExplanation(prompt, systemPrompt);
            } catch (error) {
                console.error('Error getting AI explanation:', error);
                responseText = "Oops! Something went wrong. Please try asking again!";
            }
            
            // Always hide loading indicator
            const loadingDiv = document.getElementById('ai-tutor-loading');
            if (loadingDiv) {
                loadingDiv.classList.add('hidden');
            }
            
            const tempDiv = document.getElementById('ai-response-temp');
            if (tempDiv) {
                // Check if response is an error message
                if (responseText.includes('ERROR') || responseText.includes('API key') || responseText.includes('trouble connecting')) {
                    tempDiv.innerHTML = `<strong>ü§ñ SABRINA:</strong> ${responseText}<br><br><em style="font-size: 0.9em; color: #f8b500;">üí° If this keeps happening, check your internet connection or try again in a moment.</em>`;
                    tempDiv.classList.replace('bg-gray-700/50', 'bg-red-900/50');
                    tempDiv.classList.replace('border-gray-600', 'border-red-500');
                } else {
                    tempDiv.innerHTML = `<strong>ü§ñ SABRINA:</strong> ${responseText}`;
                    tempDiv.classList.replace('bg-gray-700/50', 'bg-emerald-900/50');
                    tempDiv.classList.replace('border-gray-600', 'border-emerald-500');
                }
            }

            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function openAiTutor(initialPrompt = '') {
            document.getElementById('ai-tutor-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');

            if (initialPrompt) {
                document.getElementById('ai-tutor-output').innerHTML = `
                    <div class="mb-3 p-4 rounded-xl bg-emerald-900/50 self-start max-w-md border-2 border-emerald-500">
                        <strong>ü§ñ SABRINA:</strong> Welcome! I'm your AI Mission Tutor. Ask me anything about gravity, propulsion, or the current phase of our mission! üöÄ‚ú®
                    </div>
                `; 
                handleAiQuery(initialPrompt);
            }
        }

        function closeAiTutor() {
            document.getElementById('ai-tutor-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // AI tutor only opens when user clicks the button - no auto-open on failure
    </script>
</body>
</html>
